# docker-compose.yml

version: '3.8'

services:
  # 1. PostgreSQL Database Service
  db:
    image: postgres:16-alpine
    container_name: postgres_db
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432" # 로컬에서 DB 접속 테스트용

  # 2. FastAPI Backend Service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: fastapi_backend
    env_file:
    - ./.env
    environment:
      # FastAPI 앱이 DB에 접속하기 위해 환경 변수 전달
      DATABASE_URL: ${DATABASE_URL}
      API_HOST: ${API_HOST}
      API_PORT: ${API_PORT}
    ports:
      - "${API_PORT}:${API_PORT}" # 8000:8000
    depends_on:
      - db 
    volumes:
      - ./backend:/app 
      - ./logs:/app/logs
    command: sh -c "poetry run uvicorn app.main:app --host 0.0.0.0 --port 8000 > /app/logs/backend.log 2>&1"

  # 3. 데이터 수집 워커 컨테이너
  seoul_event_worker:
      build:
        context: ./backend
        dockerfile: Dockerfile
      container_name: seoul_event_worker
      depends_on:
        - db
      env_file:
      - ./.env
      environment:
        DATABASE_URL: ${DATABASE_URL}
        API_HOST: ${API_HOST}
        API_PORT: ${API_PORT}
      volumes:
        - ./backend:/app
        - ./logs:/app/logs
      command: sh -c "sleep 10 && poetry run python -m app.worker.collect_event_worker > /app/logs/worker.log 2>&1"
  
  # 4. Next.js Frontend Service
  frontend:
    build:
      context: . # 루트 디렉토리에서 빌드 컨텍스트 시작
      dockerfile: ./frontend/Dockerfile # 프론트엔드 Dockerfile 위치 지정
    container_name: nextjs_frontend
    ports:
      - "3000:3000" # 로컬 포트 3000을 컨테이너 포트 3000에 연결
    depends_on:
      - backend 
    volumes:
      - ./frontend:/app/frontend:ro 
      - /app/frontend/node_modules
      - ./logs:/app/logs
    command: sh -c "node_modules/.bin/next start > /app/logs/frontend.log 2>&1"
volumes:
  postgres_data: